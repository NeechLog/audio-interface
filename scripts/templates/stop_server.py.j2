"""
Script to stop the {{ service_name }} server.
"""

import argparse
import os
import signal
import sys
import time

def stop_server(pid_file):
    """Stop the server using the PID file."""
    if not os.path.exists(pid_file):
        print(f"Error: PID file '{pid_file}' not found.")
        print("Is the server running?")
        sys.exit(1)

    try:
        with open(pid_file, 'r') as f:
            content = f.read().strip()
            if not content:
                print(f"Error: PID file '{pid_file}' is empty.")
                sys.exit(1)
            pid = int(content)
    except ValueError:
        print(f"Error: Invalid PID in file '{pid_file}'.")
        sys.exit(1)
    except Exception as e:
        print(f"Error reading PID file: {e}")
        sys.exit(1)

    print(f"Stopping server with PID {pid}...")
    
    try:
        # Check if process exists
        os.kill(pid, 0)
    except ProcessLookupError:
        print(f"Process {pid} not found. It may have already stopped.")
        try:
            os.remove(pid_file)
            print(f"Removed stale PID file '{pid_file}'.")
        except OSError as e:
            print(f"Warning: Could not remove PID file: {e}")
        return
    except OSError as e:
        print(f"Error checking process: {e}")
        sys.exit(1)

    # Send SIGTERM
    try:
        os.kill(pid, signal.SIGTERM)
    except OSError as e:
        print(f"Error sending SIGTERM: {e}")
        sys.exit(1)

    # Wait for process to exit
    timeout = 10
    start_time = time.time()
    
    while time.time() - start_time < timeout:
        try:
            os.kill(pid, 0)
            time.sleep(0.5)
            print(".", end="", flush=True)
        except ProcessLookupError:
            print("\nServer stopped successfully.")
            try:
                if os.path.exists(pid_file):
                    os.remove(pid_file)
            except OSError as e:
                print(f"Warning: Could not remove PID file: {e}")
            return
    
    print("\nServer did not stop gracefully. Sending SIGKILL...")
    try:
        os.kill(pid, signal.SIGKILL)
        print("Server killed.")
    except OSError as e:
        if isinstance(e, ProcessLookupError):
            print("Server stopped.")
        else:
            print(f"Error sending SIGKILL: {e}")
    
    try:
        if os.path.exists(pid_file):
            os.remove(pid_file)
    except OSError:
        pass

def main():
    parser = argparse.ArgumentParser(description="Stop the {{ service_name }} server")
    parser.add_argument("--pid-file", default="{{ package_name.lower() }}.pid", help="Path to PID file (default: {{ package_name.lower() }}.pid)")
    
    args = parser.parse_args()
    stop_server(args.pid_file)

if __name__ == "__main__":
    main()
